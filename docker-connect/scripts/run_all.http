### 1) Create the raw stream over the telemetry topic
POST http://localhost:8088/ksql
Content-Type: application/json

{
  "ksql": "CREATE STREAM telemetry_stream ( did VARCHAR, timestamp BIGINT, name VARCHAR, float_value DOUBLE, int_value INTEGER, string_value VARCHAR, eventTime VARCHAR, receivedTime VARCHAR ) WITH ( KAFKA_TOPIC='telemetry', VALUE_FORMAT='JSON', TIMESTAMP='timestamp' );",
  "streamsProperties": {}
}

###

### 2) Create a transformed stream (flatten/normalize) that writes to telemetry_raw
POST http://localhost:8088/ksql
Content-Type: application/json

{
  "ksql": "CREATE STREAM telemetry_raw WITH ( KAFKA_TOPIC='telemetry_raw', VALUE_FORMAT='JSON' ) AS SELECT did, timestamp, eventTime, receivedTime, name, CASE WHEN float_value IS NOT NULL THEN float_value ELSE CAST(int_value AS DOUBLE) END AS value, ROWTIME AS ingest_rowtime, CASE WHEN name = 'soc' AND COALESCE(int_value,0) < 40 THEN TRUE ELSE FALSE END AS low_soc_flag FROM telemetry_stream EMIT CHANGES;",
  "streamsProperties": {}
}

###

### 3) Create a TABLE that materializes latest values per device (one row per did) and writes to vehicle_latest
POST http://localhost:8088/ksql
Content-Type: application/json

{
  "ksql": "CREATE TABLE vehicle_latest WITH ( KAFKA_TOPIC='vehicle_latest', VALUE_FORMAT='JSON' ) AS SELECT did, LATEST_BY_OFFSET(CASE WHEN name = 'odometer' THEN float_value END) AS odo, LATEST_BY_OFFSET(CASE WHEN name = 'soc' THEN int_value END) AS soc, LATEST_BY_OFFSET(CASE WHEN name = 'speed' THEN int_value END) AS speed, LATEST_BY_OFFSET(CASE WHEN name = 'ignition_status' THEN int_value END) AS ignition, LATEST_BY_OFFSET(MAX(timestamp)) AS last_event_ts FROM telemetry_stream GROUP BY did EMIT CHANGES;",
  "streamsProperties": {}
}

###

### 4) Quick push query to sample the transformed stream (streaming query; will return a chunk in VSCode)
POST http://localhost:8088/query
Content-Type: application/json

{
  "ksql": "SELECT * FROM telemetry_raw EMIT CHANGES LIMIT 5;",
  "streamsProperties": {}
}

###

### 5) Quick pull query to read the current TABLE for a sample device (pull queries work for TABLE with key)
POST http://localhost:8088/ksql
Content-Type: application/json

{
  "ksql": "SELECT * FROM vehicle_latest WHERE did='981';",
  "streamsProperties": {}
}
